<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Cellular Automata</title>
    <style>
        #canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480"></canvas>
    
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const threshold = 128; // Threshold for triggering cellular automata update
        let isRunning = false;

        // Function to apply cellular automata rule
        function applyRule(grid) {
            const newGrid = [];
            for (let i = 0; i < grid.length; i++) {
                newGrid[i] = [];
                for (let j = 0; j < grid[i].length; j++) {
                    const neighbors = countNeighbors(grid, i, j);
                    // Apply rule based on the number of neighbors
                    if (neighbors < 2) {
                        newGrid[i][j] = 0; // Cell dies from underpopulation
                    } else if (neighbors > 3) {
                        newGrid[i][j] = 0; // Cell dies from overpopulation
                    } else if (neighbors === 3) {
                        newGrid[i][j] = 1; // Cell is born
                    } else {
                        newGrid[i][j] = grid[i][j]; // Cell survives
                    }
                }
            }
            return newGrid;
        }

        // Function to count live neighbors of a cell
        function countNeighbors(grid, x, y) {
            let count = 0;
            const rows = grid.length;
            const cols = grid[0].length;
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    const row = (x + i + rows) % rows;
                    const col = (y + j + cols) % cols;
                    count += grid[row][col];
                }
            }
            count -= grid[x][y]; // Exclude the cell itself
            return count;
        }

        // Function to update canvas based on the grid
        function updateCanvas(grid) {
            const cellSize = Math.min(canvas.width / grid.length, canvas.height / grid[0].length);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < grid.length; i++) {
                for (let j = 0; j < grid[i].length; j++) {
                    if (grid[i][j] === 1) {
                        ctx.fillRect(i * cellSize, j * cellSize, cellSize, cellSize);
                    }
                }
            }
        }

        // Function to convert video frame to grayscale and update cellular automata grid
        function processVideoFrame() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const grid = [];
            for (let i = 0; i < imageData.height; i++) {
                grid[i] = [];
                for (let j = 0; j < imageData.width; j++) {
                    const index = (i * imageData.width + j) * 4;
                    // Convert RGB to grayscale
                    const brightness = (data[index] + data[index + 1] + data[index + 2]) / 3;
                    grid[i][j] = brightness < threshold ? 1 : 0;
                }
            }
            return grid;
        }

        // Function to run cellular automata
        function runAutomata() {
            if (!isRunning) {
                isRunning = true;
                const grid = processVideoFrame();
                updateCanvas(grid);
                const intervalId = setInterval(() => {
                    const newGrid = applyRule(grid);
                    updateCanvas(newGrid);
                    grid = newGrid;
                }, 100); // Adjust interval as needed
            }
        }

        // Initialize
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
                video.srcObject = stream;
                video.onloadedmetadata = function(e) {
                    runAutomata();
                };
            })
            .catch(function(err) {
                console.error('Error accessing webcam:', err);
            });
    </script>
</body>
</html>
